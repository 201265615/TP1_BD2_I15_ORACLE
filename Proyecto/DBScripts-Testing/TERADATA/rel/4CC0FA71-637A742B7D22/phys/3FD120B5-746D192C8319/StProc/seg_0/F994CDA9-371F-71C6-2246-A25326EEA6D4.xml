<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="SP_PROYECCIONTC1MES" directorySegmentName="seg_0" id="F994CDA9-371F-71C6-2246-A25326EEA6D4">
<sourceConnName>oraserveri-proyectopdb-mviales</sourceConnName>
<sourceObjSchema>MVIALES</sourceObjSchema>
<sourceObjName>SP_PROYECCIONTC1MES</sourceObjName>
<createdBy>riho</createdBy>
<createdTime>2015-04-25 02:21:51 UTC</createdTime>
<ownerDesignName>TERADATA</ownerDesignName>
<owner>289D7103-DDDA-C9FA-6967-16036284FC5F</owner>
<source>CREATE OR REPLACE PROCEDURE MVIALES.SP_PROYECCIONTC1MES(&lt;br/&gt;    PNUMVALREALES IN NUMBER,&lt;br/&gt;    PDATE IN DATE,&lt;br/&gt;    -- PARA INSERT SOLAMENTE&lt;br/&gt;    PCODMONEDA1 IN NUMBER,&lt;br/&gt;    PCODMONEDA2 IN NUMBER,&lt;br/&gt;    PCODIDECONO IN VARCHAR2,&lt;br/&gt;    PNEXTTC OUT NUMBER&lt;br/&gt;) IS&lt;br/&gt;  MES NUMBER(2);&lt;br/&gt;  ANIO NUMBER(4);&lt;br/&gt;  CURTC NUMBER(17,2);     -- VALOR DEL TC DE LA FECHA&lt;br/&gt;  TC0 NUMBER(17,2);       -- VARIABLE DE CONTROL DE MONTO DE TIPO DE CAMBIO (MININUENDO)&lt;br/&gt;  TC1 NUMBER(17,2);       -- VARIABLE DE CONTROL DE MONTO DE TIPO DE CAMBIO (SUSTRAENDO)&lt;br/&gt;  DIFF NUMBER(17,2);      -- VARIABLE DE CONTROL DE MONTO (DIFERENCIA ENTRE MONTOS DE 2 MESES CONSECUTIVOS)&lt;br/&gt;  NEWFECHA DATE;          -- NUEVA FECHA DE DONDE OBTENER EL MONTO DEL TIPO DE CAMBIO&lt;br/&gt;  CONTA NUMBER(10);       -- CONTROL DEL BUCLE&lt;br/&gt;BEGIN&lt;br/&gt;  -- INICIALIZA VARIABLES&lt;br/&gt;  -- OBTENER EL TIPO DE CAMBIO DEL MES ACTUAL&lt;br/&gt;  SP_OBTENERTC(SYSDATE, CURTC);&lt;br/&gt;  TC0 := 0.0;&lt;br/&gt;  TC1 := 0.0;&lt;br/&gt;  CONTA := 0;&lt;br/&gt;  DIFF := 0.0;&lt;br/&gt;  -- BUCLE DE RECORRIDO EN LA TABLA TC SEGUN EL NUMERO DE VALORES REALES&lt;br/&gt;  WHILE (CONTA &lt; PNUMVALREALES)&lt;br/&gt;  LOOP&lt;br/&gt;    -- OBTIENE EL TIPO DE CAMBIO DEL MES ACTUAL&lt;br/&gt;    SELECT &lt;br/&gt;      ADD_MONTHS(sysdate,- CONTA) INTO NEWFECHA &lt;br/&gt;    FROM DUAL;&lt;br/&gt;    SP_OBTENERTC(NEWFECHA,TC0);&lt;br/&gt;    -- OBTIENE EL TIPO DE CAMBIO DEL MES ANTERIOR&lt;br/&gt;    SELECT &lt;br/&gt;      ADD_MONTHS(sysdate,- (CONTA+1)) INTO NEWFECHA &lt;br/&gt;    FROM DUAL;&lt;br/&gt;    SP_OBTENERTC(NEWFECHA,TC1);&lt;br/&gt;    -- CALCULA DIFERENCIAS&lt;br/&gt;    DIFF := DIFF + (TC0 - TC1);&lt;br/&gt;    CONTA := CONTA + 1;&lt;br/&gt;  END LOOP;&lt;br/&gt;  -- CALCULA EL PROMEDIO&lt;br/&gt;  DIFF := (DIFF / PNUMVALREALES);&lt;br/&gt;  -- CALCULA EL TIPO DE CAMBIO PARA EL SIGUIENTE MES&lt;br/&gt;  CURTC := (CURTC + DIFF);&lt;br/&gt;  PNEXTTC := CURTC;&lt;br/&gt;  &lt;br/&gt;  -- INSERTAR EL MONTO COMO PROYECTADO EN LA TABLA DE MONTOS&lt;br/&gt;  SELECT &lt;br/&gt;    ADD_MONTHS(sysdate,(CONTA+1)) INTO NEWFECHA &lt;br/&gt;  FROM DUAL;&lt;br/&gt;  SELECT &lt;br/&gt;    EXTRACT(MONTH FROM NEWFECHA),EXTRACT(YEAR FROM NEWFECHA) INTO MES,ANIO&lt;br/&gt;  FROM DUAL;&lt;br/&gt;  -- INSERTAR EN LA TABLA DE MESANIO :&apos;( NOP, PUEDE DAR ERROR DE LLAVE DUPLICADA&lt;br/&gt;  -- INSERT INTO T_MESANIO VALUES (MES,ANIO);&lt;br/&gt;  -- INSERTAR EN LA TABLA DE TIPOS DE CAMBIOS&lt;br/&gt;  INSERT INTO T_TIPOCAMBIOS VALUES (PCODMONEDA1, PCODMONEDA2, PNEXTTC, PCODIDECONO, 2, MES, ANIO);&lt;br/&gt;END;</source>
<body>CREATE OR REPLACE PROCEDURE MVIALES.SP_PROYECCIONTC1MES(&lt;br/&gt;    PNUMVALREALES IN NUMBER,&lt;br/&gt;    PDATE IN DATE,&lt;br/&gt;    -- PARA INSERT SOLAMENTE&lt;br/&gt;    PCODMONEDA1 IN NUMBER,&lt;br/&gt;    PCODMONEDA2 IN NUMBER,&lt;br/&gt;    PCODIDECONO IN VARCHAR2,&lt;br/&gt;    PNEXTTC OUT NUMBER&lt;br/&gt;) IS&lt;br/&gt;  MES NUMBER(2);&lt;br/&gt;  ANIO NUMBER(4);&lt;br/&gt;  CURTC NUMBER(17,2);     -- VALOR DEL TC DE LA FECHA&lt;br/&gt;  TC0 NUMBER(17,2);       -- VARIABLE DE CONTROL DE MONTO DE TIPO DE CAMBIO (MININUENDO)&lt;br/&gt;  TC1 NUMBER(17,2);       -- VARIABLE DE CONTROL DE MONTO DE TIPO DE CAMBIO (SUSTRAENDO)&lt;br/&gt;  DIFF NUMBER(17,2);      -- VARIABLE DE CONTROL DE MONTO (DIFERENCIA ENTRE MONTOS DE 2 MESES CONSECUTIVOS)&lt;br/&gt;  NEWFECHA DATE;          -- NUEVA FECHA DE DONDE OBTENER EL MONTO DEL TIPO DE CAMBIO&lt;br/&gt;  CONTA NUMBER(10);       -- CONTROL DEL BUCLE&lt;br/&gt;BEGIN&lt;br/&gt;  -- INICIALIZA VARIABLES&lt;br/&gt;  -- OBTENER EL TIPO DE CAMBIO DEL MES ACTUAL&lt;br/&gt;  SP_OBTENERTC(SYSDATE, CURTC);&lt;br/&gt;  TC0 := 0.0;&lt;br/&gt;  TC1 := 0.0;&lt;br/&gt;  CONTA := 0;&lt;br/&gt;  DIFF := 0.0;&lt;br/&gt;  -- BUCLE DE RECORRIDO EN LA TABLA TC SEGUN EL NUMERO DE VALORES REALES&lt;br/&gt;  WHILE (CONTA &lt; PNUMVALREALES)&lt;br/&gt;  LOOP&lt;br/&gt;    -- OBTIENE EL TIPO DE CAMBIO DEL MES ACTUAL&lt;br/&gt;    SELECT &lt;br/&gt;      ADD_MONTHS(sysdate,- CONTA) INTO NEWFECHA &lt;br/&gt;    FROM DUAL;&lt;br/&gt;    SP_OBTENERTC(NEWFECHA,TC0);&lt;br/&gt;    -- OBTIENE EL TIPO DE CAMBIO DEL MES ANTERIOR&lt;br/&gt;    SELECT &lt;br/&gt;      ADD_MONTHS(sysdate,- (CONTA+1)) INTO NEWFECHA &lt;br/&gt;    FROM DUAL;&lt;br/&gt;    SP_OBTENERTC(NEWFECHA,TC1);&lt;br/&gt;    -- CALCULA DIFERENCIAS&lt;br/&gt;    DIFF := DIFF + (TC0 - TC1);&lt;br/&gt;    CONTA := CONTA + 1;&lt;br/&gt;  END LOOP;&lt;br/&gt;  -- CALCULA EL PROMEDIO&lt;br/&gt;  DIFF := (DIFF / PNUMVALREALES);&lt;br/&gt;  -- CALCULA EL TIPO DE CAMBIO PARA EL SIGUIENTE MES&lt;br/&gt;  CURTC := (CURTC + DIFF);&lt;br/&gt;  PNEXTTC := CURTC;&lt;br/&gt;  &lt;br/&gt;  -- INSERTAR EL MONTO COMO PROYECTADO EN LA TABLA DE MONTOS&lt;br/&gt;  SELECT &lt;br/&gt;    ADD_MONTHS(sysdate,(CONTA+1)) INTO NEWFECHA &lt;br/&gt;  FROM DUAL;&lt;br/&gt;  SELECT &lt;br/&gt;    EXTRACT(MONTH FROM NEWFECHA),EXTRACT(YEAR FROM NEWFECHA) INTO MES,ANIO&lt;br/&gt;  FROM DUAL;&lt;br/&gt;  -- INSERTAR EN LA TABLA DE MESANIO :&apos;( NOP, PUEDE DAR ERROR DE LLAVE DUPLICADA&lt;br/&gt;  -- INSERT INTO T_MESANIO VALUES (MES,ANIO);&lt;br/&gt;  -- INSERTAR EN LA TABLA DE TIPOS DE CAMBIOS&lt;br/&gt;  INSERT INTO T_TIPOCAMBIOS VALUES (PCODMONEDA1, PCODMONEDA2, PNEXTTC, PCODIDECONO, 2, MES, ANIO);&lt;br/&gt;END;</body>
</StoredProcedureOraclev10g>