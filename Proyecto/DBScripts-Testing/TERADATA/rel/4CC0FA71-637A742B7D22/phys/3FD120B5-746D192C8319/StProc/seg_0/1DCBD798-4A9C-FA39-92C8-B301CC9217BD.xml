<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="SP_PROYECCIONGENERAR" directorySegmentName="seg_0" id="1DCBD798-4A9C-FA39-92C8-B301CC9217BD">
<sourceConnName>oraserveri-proyectopdb-mviales</sourceConnName>
<sourceObjSchema>MVIALES</sourceObjSchema>
<sourceObjName>SP_PROYECCIONGENERAR</sourceObjName>
<createdBy>riho</createdBy>
<createdTime>2015-04-25 02:21:51 UTC</createdTime>
<ownerDesignName>TERADATA</ownerDesignName>
<owner>289D7103-DDDA-C9FA-6967-16036284FC5F</owner>
<source>CREATE OR REPLACE procedure MVIALES.SP_PROYECCIONGENERAR (&lt;br/&gt;    PCODLISTAPRECIO in number,&lt;br/&gt;    PNUMMESES in number,&lt;br/&gt;    PMSGRESPUESTA OUT VARCHAR2&lt;br/&gt;) is&lt;br/&gt;    -- Define variables utilizadas para los calculos&lt;br/&gt;    PORC1 number(3);&lt;br/&gt;    PORC2 number(3);&lt;br/&gt;    PORC3 number(3);&lt;br/&gt;    SUMPORC NUMBER(3);&lt;br/&gt;    SBTPORC NUMBER(17,2);&lt;br/&gt;    CODARTICULO VARCHAR2(20);&lt;br/&gt;    PRCARTICULO NUMBER(17,2);&lt;br/&gt;    MONTOTC NUMBER(17,2);&lt;br/&gt;    SBTPRECIOART NUMBER(17,2);&lt;br/&gt;    TPRECIOART NUMBER(17,2);&lt;br/&gt;    MES NUMBER(2);&lt;br/&gt;    ANIO NUMBER(3);&lt;br/&gt;    CONTA NUMBER(5);&lt;br/&gt;    NEWFECHA DATE;&lt;br/&gt;    -- OBTENER LOS PRECIOS DE LOS ARTICULOS ASOCIADOS A LA LISTA DE PRECIOS &lt;br/&gt;    -- CURSOR DE PRECIO DE ARTICULOS&lt;br/&gt;    CURSOR CURPRECIOARTIC IS&lt;br/&gt;    SELECT&lt;br/&gt;      ARTIC.CODIGO,&lt;br/&gt;      ARTIC.PRECIOMERCDOLARES&lt;br/&gt;    FROM T_LISTAPRECIOXARTICULOS LPXA INNER JOIN T_ARTICULOS ARTIC ON (LPXA.CODARTICULO = ARTIC.CODIGO)&lt;br/&gt;    WHERE LPXA.CODLISTAPRECIO = PCODLISTAPRECIO;&lt;br/&gt;begin&lt;br/&gt;    -- OBTENER LOS PORCENTAJES DE LA LISTA DE PRECIO&lt;br/&gt;    SELECT&lt;br/&gt;      lpr.gastoAdmin,lpr.gastoOtros,lpr.utilidad INTO PORC1, PORC2, PORC3&lt;br/&gt;    FROM T_ListaPrecios lpr&lt;br/&gt;    WHERE lpr.codigo = PCODLISTAPRECIO;&lt;br/&gt;    PMSGRESPUESTA := &apos;&apos; + &apos;Obtenido porcentajes\n&apos;;&lt;br/&gt;&lt;br/&gt;    -- CALCULAR TOTAL DE PORCENTAJES&lt;br/&gt;    SUMPORC := PORC1 + PORC2 + PORC3;&lt;br/&gt;    SBTPORC := SUMPORC / 100;&lt;br/&gt;    SBTPORC := SBTPORC + 1;&lt;br/&gt;    PMSGRESPUESTA := PMSGRESPUESTA + &apos;Calculado subtotal de porcentajes\n&apos;;&lt;br/&gt;&lt;br/&gt;    -- PARA CADA ARTICULO EN EL CURSOR, CALCULAR SU PRECIO&lt;br/&gt;    OPEN CURPRECIOARTIC;&lt;br/&gt;    LOOP&lt;br/&gt;      -- EXTRAE DATOS DEL ARTICULO&lt;br/&gt;      FETCH CURPRECIOARTIC INTO CODARTICULO, PRCARTICULO;&lt;br/&gt;      IF (CURPRECIOARTIC%FOUND) THEN&lt;br/&gt;        PMSGRESPUESTA := PMSGRESPUESTA + &apos;Dato ok en cursor\n&apos;;&lt;br/&gt;        -- INICIALIZA CALCULO DE PRECIO PARA LA CANTIDAD DE MESES ESPECIFICADA&lt;br/&gt;        CONTA := 0;&lt;br/&gt;        WHILE (CONTA &lt; PNUMMESES)&lt;br/&gt;        LOOP&lt;br/&gt;          -- INCREMENTA UN MES&lt;br/&gt;          SELECT &lt;br/&gt;            ADD_MONTHS(sysdate,CONTA) INTO NEWFECHA &lt;br/&gt;          FROM DUAL;&lt;br/&gt;          -- OBTENER EL MONTO DE TIPO DE CAMBIO PARA ESE MES&lt;br/&gt;          SP_OBTENERTC(NEWFECHA, MONTOTC);&lt;br/&gt;          -- CALCULAR SUBTOTAL DEL PRECIO DEL ARTICULO&lt;br/&gt;          SBTPRECIOART := MONTOTC * PRCARTICULO;&lt;br/&gt;          -- CALCULAR TOTAL DEL PRECIO DEL ARTICULO (APLICA PORCENTAJES)&lt;br/&gt;          TPRECIOART := SBTPRECIOART * (1 + SBTPORC);&lt;br/&gt;          -- EXTRAE EL MES Y EL ANIO DE LA FECHA&lt;br/&gt;          SELECT &lt;br/&gt;            EXTRACT(MONTH FROM NEWFECHA),EXTRACT(YEAR FROM NEWFECHA) INTO MES,ANIO&lt;br/&gt;          FROM DUAL;&lt;br/&gt;          -- INSERTA UNA FILA DE PROYECCIONES&lt;br/&gt;          INSERT INTO T_PROYECCIONESLISTAPRECIOS VALUES (CODARTICULO, PCODLISTAPRECIO, MES, ANIO, MONTOTC, TPRECIOART);&lt;br/&gt;          -- SIGUE CON EL SIGUIENTE MES DEL MISMO ARTICULO&lt;br/&gt;          CONTA := CONTA + 1;&lt;br/&gt;        END LOOP;&lt;br/&gt;      ELSE&lt;br/&gt;        PMSGRESPUESTA := PMSGRESPUESTA + &apos;No se encontro datos en cursor\n&apos;;&lt;br/&gt;      END IF;&lt;br/&gt;    EXIT WHEN CURPRECIOARTIC %NOTFOUND;&lt;br/&gt;    END LOOP;&lt;br/&gt;End;</source>
<body>CREATE OR REPLACE procedure MVIALES.SP_PROYECCIONGENERAR (&lt;br/&gt;    PCODLISTAPRECIO in number,&lt;br/&gt;    PNUMMESES in number,&lt;br/&gt;    PMSGRESPUESTA OUT VARCHAR2&lt;br/&gt;) is&lt;br/&gt;    -- Define variables utilizadas para los calculos&lt;br/&gt;    PORC1 number(3);&lt;br/&gt;    PORC2 number(3);&lt;br/&gt;    PORC3 number(3);&lt;br/&gt;    SUMPORC NUMBER(3);&lt;br/&gt;    SBTPORC NUMBER(17,2);&lt;br/&gt;    CODARTICULO VARCHAR2(20);&lt;br/&gt;    PRCARTICULO NUMBER(17,2);&lt;br/&gt;    MONTOTC NUMBER(17,2);&lt;br/&gt;    SBTPRECIOART NUMBER(17,2);&lt;br/&gt;    TPRECIOART NUMBER(17,2);&lt;br/&gt;    MES NUMBER(2);&lt;br/&gt;    ANIO NUMBER(3);&lt;br/&gt;    CONTA NUMBER(5);&lt;br/&gt;    NEWFECHA DATE;&lt;br/&gt;    -- OBTENER LOS PRECIOS DE LOS ARTICULOS ASOCIADOS A LA LISTA DE PRECIOS &lt;br/&gt;    -- CURSOR DE PRECIO DE ARTICULOS&lt;br/&gt;    CURSOR CURPRECIOARTIC IS&lt;br/&gt;    SELECT&lt;br/&gt;      ARTIC.CODIGO,&lt;br/&gt;      ARTIC.PRECIOMERCDOLARES&lt;br/&gt;    FROM T_LISTAPRECIOXARTICULOS LPXA INNER JOIN T_ARTICULOS ARTIC ON (LPXA.CODARTICULO = ARTIC.CODIGO)&lt;br/&gt;    WHERE LPXA.CODLISTAPRECIO = PCODLISTAPRECIO;&lt;br/&gt;begin&lt;br/&gt;    -- OBTENER LOS PORCENTAJES DE LA LISTA DE PRECIO&lt;br/&gt;    SELECT&lt;br/&gt;      lpr.gastoAdmin,lpr.gastoOtros,lpr.utilidad INTO PORC1, PORC2, PORC3&lt;br/&gt;    FROM T_ListaPrecios lpr&lt;br/&gt;    WHERE lpr.codigo = PCODLISTAPRECIO;&lt;br/&gt;    PMSGRESPUESTA := &apos;&apos; + &apos;Obtenido porcentajes\n&apos;;&lt;br/&gt;&lt;br/&gt;    -- CALCULAR TOTAL DE PORCENTAJES&lt;br/&gt;    SUMPORC := PORC1 + PORC2 + PORC3;&lt;br/&gt;    SBTPORC := SUMPORC / 100;&lt;br/&gt;    SBTPORC := SBTPORC + 1;&lt;br/&gt;    PMSGRESPUESTA := PMSGRESPUESTA + &apos;Calculado subtotal de porcentajes\n&apos;;&lt;br/&gt;&lt;br/&gt;    -- PARA CADA ARTICULO EN EL CURSOR, CALCULAR SU PRECIO&lt;br/&gt;    OPEN CURPRECIOARTIC;&lt;br/&gt;    LOOP&lt;br/&gt;      -- EXTRAE DATOS DEL ARTICULO&lt;br/&gt;      FETCH CURPRECIOARTIC INTO CODARTICULO, PRCARTICULO;&lt;br/&gt;      IF (CURPRECIOARTIC%FOUND) THEN&lt;br/&gt;        PMSGRESPUESTA := PMSGRESPUESTA + &apos;Dato ok en cursor\n&apos;;&lt;br/&gt;        -- INICIALIZA CALCULO DE PRECIO PARA LA CANTIDAD DE MESES ESPECIFICADA&lt;br/&gt;        CONTA := 0;&lt;br/&gt;        WHILE (CONTA &lt; PNUMMESES)&lt;br/&gt;        LOOP&lt;br/&gt;          -- INCREMENTA UN MES&lt;br/&gt;          SELECT &lt;br/&gt;            ADD_MONTHS(sysdate,CONTA) INTO NEWFECHA &lt;br/&gt;          FROM DUAL;&lt;br/&gt;          -- OBTENER EL MONTO DE TIPO DE CAMBIO PARA ESE MES&lt;br/&gt;          SP_OBTENERTC(NEWFECHA, MONTOTC);&lt;br/&gt;          -- CALCULAR SUBTOTAL DEL PRECIO DEL ARTICULO&lt;br/&gt;          SBTPRECIOART := MONTOTC * PRCARTICULO;&lt;br/&gt;          -- CALCULAR TOTAL DEL PRECIO DEL ARTICULO (APLICA PORCENTAJES)&lt;br/&gt;          TPRECIOART := SBTPRECIOART * (1 + SBTPORC);&lt;br/&gt;          -- EXTRAE EL MES Y EL ANIO DE LA FECHA&lt;br/&gt;          SELECT &lt;br/&gt;            EXTRACT(MONTH FROM NEWFECHA),EXTRACT(YEAR FROM NEWFECHA) INTO MES,ANIO&lt;br/&gt;          FROM DUAL;&lt;br/&gt;          -- INSERTA UNA FILA DE PROYECCIONES&lt;br/&gt;          INSERT INTO T_PROYECCIONESLISTAPRECIOS VALUES (CODARTICULO, PCODLISTAPRECIO, MES, ANIO, MONTOTC, TPRECIOART);&lt;br/&gt;          -- SIGUE CON EL SIGUIENTE MES DEL MISMO ARTICULO&lt;br/&gt;          CONTA := CONTA + 1;&lt;br/&gt;        END LOOP;&lt;br/&gt;      ELSE&lt;br/&gt;        PMSGRESPUESTA := PMSGRESPUESTA + &apos;No se encontro datos en cursor\n&apos;;&lt;br/&gt;      END IF;&lt;br/&gt;    EXIT WHEN CURPRECIOARTIC %NOTFOUND;&lt;br/&gt;    END LOOP;&lt;br/&gt;End;</body>
</StoredProcedureOraclev10g>